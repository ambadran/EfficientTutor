<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EfficientTutor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a1a;
            --surface-color: #2c2c2c;
            --primary-color: #4f46e5;
            --text-color: #e5e7eb;
            --text-muted-color: #9ca3af;
            --border-color: #404040;
            --school-color: #facc15; /* yellow-400 */
            --sports-color: #f97316; /* orange-500 */
            --others-color: #4ade80; /* green-400 */
            --tuition-color: #60a5fa; /* blue-400 */
        }
        html.light {
            --bg-color: #f3f4f6;
            --surface-color: #ffffff;
            --primary-color: #4f46e5;
            --text-color: #111827;
            --text-muted-color: #6b7280;
            --border-color: #e5e7eb;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overscroll-behavior: none;
        }
        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }
        .sidebar {
            width: 250px;
            background-color: var(--surface-color);
            border-right: 1px solid var(--border-color);
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            z-index: 50;
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .main-content {
            flex-grow: 1;
            transition: margin-left 0.3s ease-in-out;
            height: 100vh;
            overflow-y: auto;
        }
        .timetable-grid {
            position: relative;
            height: calc(21 * 60px); /* 6 AM to 2 AM next day */
        }
        .time-label {
            height: 60px;
        }
        .event-bubble {
            position: absolute;
            left: 0;
            right: 0;
            margin: 0 4px;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.8rem;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.2);
            color: #111827;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.7);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .modal-content {
            background-color: var(--surface-color);
            padding: 1.5rem;
            border-radius: 1rem;
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }
        .modal-header, .modal-footer {
            flex-shrink: 0;
        }
        .modal-body {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 0.5rem;
            margin-right: -0.5rem;
            padding-bottom: 1rem;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (min-width: 768px) {
            .sidebar {
                position: static;
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
            #menu-button { display: none; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="app-container" class="app-container">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar flex flex-col p-4">
            <h1 class="text-2xl font-bold text-indigo-400 mb-8">EfficientTutor</h1>
            <nav class="flex flex-col space-y-2">
                <a href="#" id="nav-timetable" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700"><i class="fas fa-calendar-alt w-6 mr-3"></i> Timetable</a>
                <a href="#" id="nav-logs" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700"><i class="fas fa-history w-6 mr-3"></i> Logs</a>
                <a href="#" id="nav-student-info" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700"><i class="fas fa-user-graduate w-6 mr-3"></i> Student Info</a>
                <a href="#" id="nav-settings" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700"><i class="fas fa-cog w-6 mr-3"></i> Settings</a>
            </nav>
            <div class="mt-auto">
                <div id="user-info" class="text-sm text-gray-400 mb-2 hidden">
                    <p>Logged in as:</p>
                    <p id="user-email" class="font-semibold break-all"></p>
                </div>
                <button id="logout-button" class="w-full text-left flex items-center p-2 rounded-lg hover:bg-red-800/50 text-red-400 hidden">
                    <i class="fas fa-sign-out-alt w-6 mr-3"></i> Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="main-content">
            <header class="sticky top-0 bg-gray-900/80 backdrop-blur-sm p-4 flex items-center border-b border-gray-700 z-40">
                <button id="menu-button" class="md:hidden mr-4 p-2 rounded-md hover:bg-gray-700">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <h2 id="page-title" class="text-xl font-semibold">Login</h2>
            </header>
            <div id="page-content" class="p-4 md:p-6">
                <!-- All pages will be rendered here -->
            </div>
        </main>
    </div>

    <!-- Modals will be appended here -->
    <div id="modal-container"></div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const config = {
            // *** FIX: Updated backendUrl to use your live, secure Render URL ***
            backendUrl: 'https://personal-time-manager.onrender.com',
            subjects: ['Math', 'Physics', 'Chemistry', 'Biology', 'IT'],
            colors: {
                school: 'var(--school-color)',
                sports: 'var(--sports-color)',
                others: 'var(--others-color)',
                tuition: 'var(--tuition-color)',
            },
            defaultSchoolTimes: { start: '06:00', end: '15:00' },
            daysOfWeek: ['Saturday', 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'],
            timeSlotsStartHour: 6, // 6 AM
            pixelsPerMinute: 1, // 60px per hour
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let appState = {
            currentUser: null,
            students: [],
            currentStudent: null,
            currentPage: 'login',
            currentTimetableDay: new Date().getDay() + 1 > 6 ? 0 : new Date().getDay() + 1, // Saturday is 0
            isSidebarOpen: false,
            isFirstSignIn: false,
        };
        
        let studentDataUnsubscribe = () => {};

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async user => {
            if (user) {
                appState.currentUser = user;
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('logout-button').classList.remove('hidden');
                document.getElementById('user-email').textContent = user.email || 'Anonymous';
                
                const userProfileRef = doc(db, `artifacts/${appId}/users/${user.uid}/metadata`, 'profile');
                const userProfileSnap = await getDoc(userProfileRef);

                if (!userProfileSnap.exists()) {
                    await setDoc(userProfileRef, { createdAt: new Date(), isFirstSignIn: true });
                    appState.isFirstSignIn = true;
                    navigateTo('student-info');
                } else {
                    appState.isFirstSignIn = userProfileSnap.data().isFirstSignIn || false;
                    if(appState.isFirstSignIn && appState.students.length === 0) {
                        navigateTo('student-info');
                    } else {
                        navigateTo('timetable');
                    }
                }
                listenToStudents();

            } else {
                appState.currentUser = null;
                appState.students = [];
                appState.currentStudent = null;
                if(studentDataUnsubscribe) studentDataUnsubscribe();
                document.getElementById('user-info').classList.add('hidden');
                document.getElementById('logout-button').classList.add('hidden');
                navigateTo('login');
            }
        });

        // --- NAVIGATION & PAGE RENDERING ---
        const pageContent = document.getElementById('page-content');
        const pageTitle = document.getElementById('page-title');

        function navigateTo(pageId) {
            appState.currentPage = pageId;
            if (appState.isSidebarOpen) toggleSidebar();
            renderPage();
        }

        async function renderPage() {
            pageContent.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader"></div></div>`;
            try {
                switch(appState.currentPage) {
                    case 'login':
                        pageTitle.textContent = 'Login / Sign Up';
                        pageContent.innerHTML = renderLoginPage();
                        break;
                    case 'timetable':
                        pageTitle.textContent = 'Timetable';
                        pageContent.innerHTML = await renderTimetablePage();
                        break;
                    case 'logs':
                        pageTitle.textContent = 'Logs';
                        pageContent.innerHTML = await renderLogsPage();
                        break;
                    case 'student-info':
                        pageTitle.textContent = 'Student Info';
                        pageContent.innerHTML = renderStudentInfoPage();
                        break;
                    case 'settings':
                        pageTitle.textContent = 'Settings';
                        pageContent.innerHTML = renderSettingsPage();
                        break;
                }
            } catch (error) {
                console.error("Failed to render page:", error);
                pageContent.innerHTML = `<div class="text-center text-red-400 p-8">Error loading page. Please check the connection to the backend.</div>`;
            }
        }
        
        // --- EVENT HANDLERS (Using Event Delegation) ---
        document.body.addEventListener('click', (e) => {
            const target = e.target;
            const closest = (selector) => target.closest(selector);

            if (closest('#login-btn')) {
                e.preventDefault();
                handleLogin(document.getElementById('email').value, document.getElementById('password').value);
            }
            if (closest('#signup-btn')) {
                e.preventDefault();
                handleSignup(document.getElementById('email').value, document.getElementById('password').value);
            }
            if (closest('#logout-button')) handleLogout();

            const navLink = closest('.nav-link');
            if (navLink) {
                e.preventDefault();
                navigateTo(navLink.id.replace('nav-', ''));
            }
            if (closest('#menu-button')) toggleSidebar();
            if (closest('#add-new-student-btn')) showStudentRegistrationWizard();

            const editStudentBtn = closest('.edit-student-btn');
            if (editStudentBtn) {
                const student = appState.students.find(s => s.id === editStudentBtn.dataset.id);
                if (student) showStudentRegistrationWizard(student);
            }
            const deleteStudentBtn = closest('.delete-student-btn');
            if (deleteStudentBtn) {
                const student = appState.students.find(s => s.id === deleteStudentBtn.dataset.id);
                if (student) confirmDeleteStudent(student);
            }
            if (closest('#theme-toggle-btn')) {
                document.documentElement.classList.toggle('dark');
                document.documentElement.classList.toggle('light');
                renderPage();
            }
            if (closest('#modal-close-btn') || (closest('#modal-backdrop') && !closest('.modal-content'))) {
                closeModal();
            }
            
            const mainTimetable = closest('#page-content .timetable-component');
            if (mainTimetable) {
                const dayNavBtn = closest('.day-nav-btn');
                if (dayNavBtn) {
                    const dir = parseInt(dayNavBtn.dataset.direction);
                    appState.currentTimetableDay = (appState.currentTimetableDay + dir + 7) % 7;
                    renderPage(); // Re-render the whole page to update timetable
                }
            }
        });
        
        pageContent.addEventListener('change', (e) => {
            if (e.target.id === 'student-selector') {
                appState.currentStudent = appState.students.find(s => s.id === e.target.value) || null;
                renderPage();
            }
        });

        // --- AUTH FUNCTIONS ---
        async function handleLogin(email, password) {
            try {
                await setPersistence(auth, browserLocalPersistence);
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showInfoModal('Error', `<p class="text-red-400">${error.message}</p>`);
            }
        }
        async function handleSignup(email, password) {
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showInfoModal('Error', `<p class="text-red-400">${error.message}</p>`);
            }
        }
        async function handleLogout() { await signOut(auth); }

        // --- TEMPLATES ---
        function renderLoginPage() {
            return `<div class="max-w-md mx-auto mt-10 bg-gray-800 p-8 rounded-xl shadow-lg">
                    <h3 class="text-2xl font-bold text-center mb-6">Welcome to EfficientTutor</h3>
                    <form id="login-form" class="space-y-4">
                        <input type="email" id="email" placeholder="Email" required class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        <input type="password" id="password" placeholder="Password" required class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        <div class="flex space-x-4">
                            <button type="submit" id="login-btn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md transition duration-300">Login</button>
                            <button type="button" id="signup-btn" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-md transition duration-300">Sign Up</button>
                        </div>
                    </form>
                </div>`;
        }
        function renderStudentInfoPage() {
            let studentListHTML = appState.students.map(student => `
                <div class="bg-gray-800 p-4 rounded-lg flex items-center justify-between">
                    <div>
                        <p class="font-semibold text-lg">${student.basicInfo.firstName} ${student.basicInfo.lastName}</p>
                        <p class="text-sm text-gray-400">Grade: ${student.basicInfo.grade}</p>
                    </div>
                    <div class="space-x-2">
                        <button class="edit-student-btn p-2 bg-gray-600 hover:bg-gray-500 rounded-md" data-id="${student.id}"><i class="fas fa-edit"></i></button>
                        <button class="delete-student-btn p-2 bg-red-600 hover:bg-red-500 rounded-md" data-id="${student.id}"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`).join('');
            if (appState.students.length === 0) {
                studentListHTML = `<p class="text-center text-gray-400 py-8">No students registered yet. Add one to get started!</p>`;
            }
            return `<div class="space-y-4">${studentListHTML}</div>
                <button id="add-new-student-btn" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i> Add New Student
                </button>`;
        }
        
        function confirmDeleteStudent(student) {
            const footer = `<div class="flex justify-end space-x-4">
                    <button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md">Cancel</button>
                    <button id="modal-confirm-delete-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-md">Delete</button>
                 </div>`;
            showModal('Confirm Deletion', `<p>Are you sure you want to delete ${student.basicInfo.firstName}?</p>`, footer,
                 (modal) => {
                    modal.addEventListener('click', (e) => {
                        if (e.target.closest('#modal-confirm-delete-btn')) {
                            deleteStudent(student.id);
                            closeModal();
                        }
                        if (e.target.closest('#modal-cancel-btn')) closeModal();
                    });
                 });
        }

        // --- STUDENT REGISTRATION WIZARD ---
        function showStudentRegistrationWizard(studentToEdit = null) {
            let step = 1;
            let registrationData = studentToEdit ? JSON.parse(JSON.stringify(studentToEdit)) : {
                basicInfo: { firstName: '', lastName: '', grade: '' },
                subjects: [],
                availability: {}
            };
            
            if (!studentToEdit) {
                config.daysOfWeek.forEach(day => {
                    registrationData.availability[day.toLowerCase()] = [];
                    if (day !== 'Saturday' && day !== 'Friday') {
                        registrationData.availability[day.toLowerCase()].push({ type: 'school', ...config.defaultSchoolTimes });
                    }
                });
            }

            const renderCurrentStep = () => {
                let bodyContent = '', footerContent = '';
                switch(step) {
                    case 1: 
                        bodyContent = wizardStep1(registrationData);
                        footerContent = `<div class="flex justify-end"><button id="wizard-next-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Next</button></div>`;
                        break;
                    case 2: 
                        bodyContent = wizardStep2(registrationData);
                        footerContent = `<div class="flex justify-end"><button id="wizard-next-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Next</button></div>`;
                        break;
                    case 3: 
                        bodyContent = wizardStep3(registrationData);
                        footerContent = `<div class="flex justify-end"><button id="wizard-next-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Next</button></div>`;
                        break;
                    case 4: 
                        bodyContent = wizardStep4();
                        footerContent = `<div class="flex justify-center"><button id="wizard-finish-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-md">Finish</button></div>`;
                        break;
                }
                showModal(`Student Registration - Step ${step} of 4`, bodyContent, footerContent, (modal) => {
                    attachWizardListeners(modal);
                });
            };

            const attachWizardListeners = (modal) => {
                modal.addEventListener('click', async (e) => {
                    const target = e.target;
                    const closest = (selector) => target.closest(selector);

                    if (closest('#wizard-next-btn')) {
                        if (validateStep(step, registrationData, modal)) {
                            step++;
                            renderCurrentStep();
                        }
                    } else if (closest('#wizard-finish-btn')) {
                        await saveStudent(registrationData);
                        closeModal();
                    }

                    if (step === 2) {
                        if (closest('#add-subject-btn')) {
                            const name = modal.querySelector('#subject-select').value;
                            const lessonsPerWeek = parseInt(modal.querySelector('#lessons-per-week').value);
                            if (lessonsPerWeek > 0 && !registrationData.subjects.find(s => s.name === name)) {
                                registrationData.subjects.push({ name, lessonsPerWeek });
                                renderCurrentStep();
                            }
                        }
                        const removeBtn = closest('.remove-subject-btn');
                        if (removeBtn) {
                            registrationData.subjects.splice(parseInt(removeBtn.dataset.index), 1);
                            renderCurrentStep();
                        }
                    }
                    
                    if (step === 3) {
                        const dayNavBtn = closest('.day-nav-btn');
                        if (dayNavBtn) {
                            const dir = parseInt(dayNavBtn.dataset.direction);
                            appState.currentTimetableDay = (appState.currentTimetableDay + dir + 7) % 7;
                            renderCurrentStep();
                        }
                        const grid = closest('#timetable-grid-main');
                        if(grid && e.target === grid) {
                            const dayKey = grid.dataset.dayKey;
                            showAddEventModal(registrationData, dayKey, e.offsetY, renderCurrentStep);
                        }
                        const bubble = closest('.event-bubble');
                        if (bubble) {
                            const dayKey = grid.dataset.dayKey;
                            const type = bubble.dataset.type;
                            if (type !== 'tuition') {
                                showEditEventModal(registrationData, dayKey, bubble.dataset.start, renderCurrentStep);
                            }
                        }
                    }
                });
            };
            renderCurrentStep();
        }

        function wizardStep1(data) { return `<div class="space-y-4"><input type="text" id="firstName" placeholder="First Name" value="${data.basicInfo.firstName}" required class="w-full p-3 bg-gray-700 rounded-md border border-gray-600"><input type="text" id="lastName" placeholder="Last Name" value="${data.basicInfo.lastName}" required class="w-full p-3 bg-gray-700 rounded-md border border-gray-600"><input type="text" id="grade" placeholder="Grade (e.g., 10)" value="${data.basicInfo.grade}" required class="w-full p-3 bg-gray-700 rounded-md border border-gray-600"></div>`; }
        function wizardStep2(data) {
            const subjectOptions = config.subjects.map(s => `<option value="${s}">${s}</option>`).join('');
            const registeredSubjectsHTML = data.subjects.map((s, index) => `<div class="bg-gray-700 p-2 rounded-md flex justify-between items-center"><span>${s.name} - ${s.lessonsPerWeek} lessons/week</span><button class="remove-subject-btn text-red-400 hover:text-red-300" data-index="${index}"><i class="fas fa-times-circle"></i></button></div>`).join('');
            return `<div id="registered-subjects-list" class="space-y-2 mb-4">${registeredSubjectsHTML || '<p class="text-sm text-gray-400">No subjects added yet.</p>'}</div><div class="flex space-x-2"><select id="subject-select" class="flex-grow p-2 bg-gray-700 rounded-md border border-gray-600">${subjectOptions}</select><input type="number" id="lessons-per-week" placeholder="Lessons/wk" min="1" value="1" class="w-28 p-2 bg-gray-700 rounded-md border border-gray-600"><button id="add-subject-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold p-2 rounded-md"><i class="fas fa-plus"></i> Add</button></div>`;
        }
        function wizardStep3(data) { return `<div id="wizard-timetable-container">${renderTimetableComponent(true, data)}</div>`; }
        function wizardStep4() { return `<div class="text-center py-8"><i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i><h3 class="text-2xl font-semibold">All Set!</h3><p class="text-gray-400 mt-2">All student information has been entered. Click Finish to save.</p></div>`; }
        function validateStep(step, data, modal) {
            if (step === 1) {
                const firstName = modal.querySelector('#firstName').value.trim();
                const lastName = modal.querySelector('#lastName').value.trim();
                const grade = modal.querySelector('#grade').value.trim();
                if (!firstName || !lastName || !grade) {
                    showInfoModal('Validation Error', '<p>Please fill in all fields.</p>');
                    return false;
                }
                data.basicInfo = { firstName, lastName, grade };
            }
            return true;
        }

        // --- DATABASE & BACKEND ---
        function listenToStudents() {
            if (!appState.currentUser) return;
            const studentsCol = collection(db, `artifacts/${appId}/users/${appState.currentUser.uid}/students`);
            studentDataUnsubscribe = onSnapshot(studentsCol, (snapshot) => {
                appState.students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const currentStudentExists = appState.currentStudent && appState.students.some(s => s.id === appState.currentStudent.id);
                if (!currentStudentExists) appState.currentStudent = appState.students[0] || null;
                if(appState.currentPage !== 'login') renderPage();
            }, (error) => console.error("Error listening to students:", error));
        }

        async function saveStudent(studentData) {
            if (!appState.currentUser) return;
            const studentCol = collection(db, `artifacts/${appId}/users/${appState.currentUser.uid}/students`);
            try {
                let studentId = studentData.id;
                if (studentId) {
                    await updateDoc(doc(studentCol, studentId), studentData);
                } else {
                    const newDocRef = await addDoc(studentCol, studentData);
                    studentId = newDocRef.id;
                }
                
                const response = await fetch(`${config.backendUrl}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ student_id: studentId, ...studentData })
                });
                if (!response.ok) throw new Error('Backend registration failed.');
                const backendResult = await response.json();
                console.log('Backend response:', backendResult);

                if (appState.isFirstSignIn) {
                    const userProfileRef = doc(db, `artifacts/${appId}/users/${appState.currentUser.uid}/metadata`, 'profile');
                    await updateDoc(userProfileRef, { isFirstSignIn: false });
                    appState.isFirstSignIn = false;
                }
            } catch (error) {
                console.error("Error saving student or registering with backend:", error);
                showInfoModal('Error', `<p>Could not save student data. ${error.message}</p>`);
            }
        }
        
        async function deleteStudent(studentId) {
            if (!appState.currentUser) return;
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${appState.currentUser.uid}/students`, studentId));
            } catch (error) {
                console.error("Error deleting student:", error);
                showInfoModal('Error', `<p>Could not delete student.</p>`);
            }
        }
        
        // --- TIMETABLE ---
        async function renderTimetablePage() {
            if (!appState.currentStudent) return `<div class="text-center p-8 text-gray-400">No student selected. Please add or select a student from the 'Student Info' page.</div>`;
            
            try {
                const response = await fetch(`${config.backendUrl}/timetable?student_id=${appState.currentStudent.id}`);
                if (!response.ok) throw new Error('Failed to fetch timetable from backend.');
                const backendTimetable = await response.json();
                return renderTimetableComponent(false, appState.currentStudent, backendTimetable.tuitions);
            } catch (error) {
                console.error("Error fetching timetable:", error);
                showInfoModal('Backend Error', `<p>${error.message}</p>`);
                return renderTimetableComponent(false, appState.currentStudent, []); // Render with no tuitions on error
            }
        }

        function renderTimetableComponent(isWizard, dataSource, tuitions = []) {
            const currentDayIndex = appState.currentTimetableDay;
            const currentDayName = config.daysOfWeek[currentDayIndex];
            const dayKey = currentDayName.toLowerCase();
            
            const availability = dataSource.availability ? (dataSource.availability[dayKey] || []) : [];
            const tuitionsForDay = isWizard ? [] : tuitions.filter(t => t.day === dayKey);

            let timeLabelsHTML = '';
            for (let hour = config.timeSlotsStartHour; hour < 24 + config.timeSlotsStartHour - 1; hour++) {
                const displayHour = hour % 24;
                const ampm = displayHour >= 12 ? 'PM' : 'AM';
                let formattedHour = displayHour % 12;
                if (formattedHour === 0) formattedHour = 12;
                timeLabelsHTML += `<div class="time-label text-right pr-2 text-xs text-gray-500 border-t border-gray-700 flex items-center justify-end">${formattedHour} ${ampm}</div>`;
            }
            
            const timeToPixels = (timeStr) => {
                if(!timeStr) return 0;
                const [h, m] = timeStr.split(':').map(Number);
                const totalMinutes = h * 60 + m;
                const offsetMinutes = config.timeSlotsStartHour * 60;
                return (totalMinutes - offsetMinutes) * config.pixelsPerMinute;
            }

            const eventBubblesHTML = [...availability, ...tuitionsForDay].map(event => {
                if(!event.start || !event.end) return '';
                const top = timeToPixels(event.start);
                const bottom = timeToPixels(event.end);
                const height = bottom - top;
                if (height <= 0) return '';
                const isTuition = !!event.subject;
                const type = isTuition ? 'tuition' : event.type;
                const color = config.colors[type];
                const text = isTuition ? event.subject : event.type;
                
                return `<div class="event-bubble ${type !== 'tuition' ? 'cursor-pointer' : ''} hover:opacity-80" 
                         style="background-color: ${color}; top: ${top}px; height: ${height}px;"
                         data-type="${type}" data-start="${event.start}" data-end="${event.end}">
                        <p class="font-bold capitalize">${text}</p>
                        <p>${event.start} - ${event.end}</p>
                    </div>`;
            }).join('');

            return `<div class="timetable-component">
                    ${!isWizard ? renderStudentSelector() : ''}
                    <div class="flex justify-between items-center p-4 bg-gray-800 rounded-lg mb-4">
                        <button class="day-nav-btn p-2 rounded-md hover:bg-gray-700" data-direction="-1"><i class="fas fa-chevron-left"></i></button>
                        <h3 class="text-xl font-semibold">${currentDayName}</h3>
                        <button class="day-nav-btn p-2 rounded-md hover:bg-gray-700" data-direction="1"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="flex">
                        <div class="w-16 flex-shrink-0">${timeLabelsHTML}</div>
                        <div class="timetable-grid flex-grow bg-gray-800/50 rounded-lg" id="timetable-grid-main" data-day-key="${dayKey}">
                            ${eventBubblesHTML}
                        </div>
                    </div>
                </div>`;
        }
        
        function renderStudentSelector() {
            if (appState.students.length <= 1) return '';
            const options = appState.students.map(s => `<option value="${s.id}" ${appState.currentStudent && appState.currentStudent.id === s.id ? 'selected' : ''}>${s.basicInfo.firstName} ${s.basicInfo.lastName}</option>`).join('');
            return `<div class="mb-4"><label for="student-selector" class="text-sm text-gray-400">Viewing Timetable for:</label><select id="student-selector" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600">${options}</select></div>`;
        }
        
        function showAddEventModal(dataSource, dayKey, pixelY, onUpdate) {
            const totalMinutes = (pixelY / config.pixelsPerMinute) + (config.timeSlotsStartHour * 60);
            const hour = Math.floor(totalMinutes / 60);
            const minute = Math.floor(totalMinutes % 60 / 15) * 15;
            const startTime = `${String(hour).padStart(2,'0')}:${String(minute).padStart(2,'0')}`;

            const body = `<div class="space-y-4"><div><label class="text-sm text-gray-400">Activity Type</label><select id="add-event-type" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600"><option value="sports">Sports Activity</option><option value="others">Others</option></select></div><div class="grid grid-cols-2 gap-4"><div><label class="text-sm text-gray-400">Start Time</label><input type="time" id="add-event-start" value="${startTime}" step="900" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600"></div><div><label class="text-sm text-gray-400">End Time</label><input type="time" id="add-event-end" value="${startTime}" step="900" class="w-full mt-1 p-2 bg-gray-700 rounded-md border border-gray-600"></div></div></div>`;
            const footer = `<div class="flex justify-end space-x-4"><button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md">Cancel</button><button id="modal-confirm-add-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Add</button></div>`;
            
            showModal('Add Activity', body, footer, (modal) => {
                modal.addEventListener('click', e => {
                    if (e.target.closest('#modal-cancel-btn')) closeModal(modal);
                    if (e.target.closest('#modal-confirm-add-btn')) {
                        const type = modal.querySelector('#add-event-type').value;
                        const start = modal.querySelector('#add-event-start').value;
                        const end = modal.querySelector('#add-event-end').value;
                        if (start && end && start < end) {
                            dataSource.availability[dayKey].push({type, start, end});
                            onUpdate();
                            closeModal(modal);
                        } else { alert('End time must be after start time.'); }
                    }
                });
            });
        }
        function showEditEventModal(dataSource, dayKey, startTime, onUpdate) { /* ... implementation unchanged ... */ }
        
        // --- TEMPLATE: LOGS & SETTINGS ---
        async function renderLogsPage() {
            if (!appState.currentStudent) return `<div class="text-center p-8 text-gray-400">Select a student to view logs.</div>`;

            try {
                const response = await fetch(`${config.backendUrl}/logs?student_id=${appState.currentStudent.id}`);
                if (!response.ok) throw new Error('Failed to fetch logs from backend.');
                const logData = await response.json();
                
                const { summary, detailed_logs } = logData;
                const logsHTML = detailed_logs.map(log => `
                    <div class="bg-gray-800 p-4 rounded-lg grid grid-cols-3 md:grid-cols-4 gap-4 items-center">
                        <div><p class="font-semibold">${log.subject}</p><p class="text-sm text-gray-400">${log.date}</p></div>
                        <div class="text-sm text-gray-400 text-center"><p>${log.time_start} - ${log.time_end}</p></div>
                        <div class="text-center">${log.duration}</div>
                        <div class="text-center"><span class="px-3 py-1 rounded-full text-sm font-semibold ${log.status === 'Paid' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">${log.status}</span></div>
                    </div>`).join('');

                return `<div class="space-y-6">
                        <div><h3 class="text-xl font-semibold mb-4">Summary</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="bg-gray-800 p-4 rounded-lg text-center"><p class="text-3xl font-bold text-red-500">${summary.unpaid_count}</p><p class="text-gray-400">Lessons Unpaid</p></div>
                                <div class="bg-gray-800 p-4 rounded-lg text-center"><p class="text-3xl font-bold text-green-500">${summary.paid_count}</p><p class="text-gray-400">Lessons Paid</p></div>
                                <div class="bg-gray-800 p-4 rounded-lg text-center"><p class="text-3xl font-bold text-yellow-400">$${summary.total_due.toFixed(2)}</p><p class="text-gray-400">Total Amount Due</p></div>
                            </div>
                        </div>
                        <div><h3 class="text-xl font-semibold mb-4">Detailed Logs</h3><div class="space-y-2">${logsHTML}</div></div>
                    </div>`;
            } catch (error) {
                console.error("Error fetching logs:", error);
                showInfoModal('Backend Error', `<p>${error.message}</p>`);
                return `<div class="text-center text-red-400 p-8">Error loading logs.</div>`;
            }
        }
        function renderSettingsPage() {
            const isDark = document.documentElement.classList.contains('dark');
            return `<div class="max-w-2xl mx-auto space-y-6"><div class="bg-gray-800 p-6 rounded-lg"><h3 class="text-lg font-semibold mb-4">Appearance</h3><div class="flex items-center justify-between"><span>Theme</span><button id="theme-toggle-btn" class="px-4 py-2 rounded-md font-semibold ${isDark ? 'bg-gray-700' : 'bg-gray-300 text-gray-800'}">${isDark ? '<i class="fas fa-moon mr-2"></i>Dark' : '<i class="fas fa-sun mr-2"></i>Light'}</button></div></div><div class="bg-gray-800 p-6 rounded-lg"><h3 class="text-lg font-semibold mb-4">About</h3><p class="text-gray-400">EfficientTutor v1.0.0</p></div></div>`;
        }

        // --- MODAL UTILITIES ---
        function showModal(title, bodyHTML, footerHTML, onAfterRender) {
            closeModal();
            const modalContainer = document.getElementById('modal-container');
            const modal = document.createElement('div');
            modal.id = 'modal-backdrop';
            modal.className = 'modal-backdrop';
            modal.innerHTML = `<div class="modal-content"><div class="modal-header flex justify-between items-center mb-4"><h3 class="text-xl font-semibold">${title}</h3><button id="modal-close-btn" class="p-2 rounded-full hover:bg-gray-700 -mr-2 -mt-2"><i class="fas fa-times"></i></button></div><div class="modal-body">${bodyHTML}</div><div class="modal-footer mt-4">${footerHTML}</div></div>`;
            modalContainer.appendChild(modal);
            if (onAfterRender) onAfterRender(modal);
        }
        function showInfoModal(title, bodyHTML) { showModal(title, bodyHTML, `<div class="flex justify-end"><button id="modal-close-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">OK</button></div>`); }
        function closeModal(modal = null) { (modal || document.getElementById('modal-backdrop'))?.remove(); }
        function toggleSidebar() { appState.isSidebarOpen = !appState.isSidebarOpen; document.getElementById('sidebar').classList.toggle('open'); }

        // --- INITIALIZATION ---
        (async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else if (!auth.currentUser) console.log("No initial token, user needs to log in.");
            } catch (error) {
                console.error("Auth Error:", error);
                if (!auth.currentUser) await signInAnonymously(auth).catch(err => console.error("Anonymous sign-in failed:", err));
            }
        })();
    </script>
</body>
</html>
